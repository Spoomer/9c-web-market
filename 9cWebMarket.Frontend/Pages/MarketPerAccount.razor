@page "/MarketPerAccount"
@using GraphQL.Client.Abstractions.Utilities
@using Nekoyume.Model.Item
@using NineCWebMarket.Frontend.Api
@using NineCWebMarket.Frontend.Services
@inject NavigationManager NavigationManager
@inject IApiClient ApiClient
@inject NineCapiService MarketService
@inject Blazored.LocalStorage.ILocalStorageService LocalStorage

<div class="container" style="scroll-behavior: smooth">
    <div class="input-group mb-3" style="min-width: 200px; height: 25%">
        <label class="input-group-text" for="planet-select">Planet</label>
        <select class="form-select" id="planet-select" @onchange="OnPlanetSelectChange">
            @foreach (var planet in _planets)
            {
                <option value="@planet" selected="@(planet == _selectedPlanet)">@planet.Capitalize()</option>
            }
        </select>
    </div>
    <h3>@_selectedPlanet.Capitalize() Market</h3>
    <div id="header" class="d-flex justify-content-evenly">
        <div id="avatar-address" class="pt-3 pb-2 container bg-body-secondary me-2 rounded-2 flex-grow-1">
            <h4>Avatar Address</h4>
            <input value="@_avatarAddress" @onchange="OnAvatarAddressChange" type="text" class="form-control" id="floatingInput" placeholder="0x..">
        </div>
        <div id="search" class="pt-3 pb-2 container bg-body-secondary rounded-2 flex-grow-1">
            <h4>Search</h4>
            <input type="text" class="form-control" placeholder="min. 3 characters" @onchange="OnSearchInputChange">
        </div>
    </div>
</div>
<MarketList Planet="@_selectedPlanet" Search="@_currentSearch" SubType="_subtype" SortBy="_sortBy" SortDirection="_sortDirection" @bind-Loading="@_loading" MarketService="MarketService"
            AvatarAddress="@_avatarAddress"/>
@code {
    private ItemSubType _subtype = ItemSubType.Armor;
    private ProductSortBy _sortBy = ProductSortBy.CP;
    private SortDirection _sortDirection = SortDirection.DESCENDING;
    private string _selectedPlanet = "heimdall";
    private IReadOnlyCollection<string> _planets = [];
    private bool _loading;
    private string _avatarAddress = "";
    private const string AvatarAdressKey = "AvatarAdress";
    private string _currentSearch = string.Empty;

    public override async Task SetParametersAsync(ParameterView parameters)
    {
        parameters.SetParameterProperties(this);
        await InitAsync();
        await base.SetParametersAsync(ParameterView.Empty);
    }

    private async Task InitAsync()
    {
        if (_planets.Count != 0)
        {
            return;
        }

        _planets = await ApiClient.GetPlanetsNamesAsync();
        //no thor support
        _planets = _planets.Where(x => x != "thor").ToArray();
        
        SetSelectedPlanetFromUrl();

        if (await LocalStorage.ContainKeyAsync(AvatarAdressKey))
        {
            _avatarAddress = await LocalStorage.GetItemAsStringAsync(AvatarAdressKey) ?? string.Empty;
            _loading = true;
        }
    }
    
    private bool SetSelectedPlanetFromUrl()
    {
        var uri = new Uri(NavigationManager.Uri, UriKind.Absolute);

        if (!uri.Fragment.StartsWith('#')) return false;

        var planetFromFragment = uri.Fragment[1..];

        return SetPlanet(planetFromFragment);
    }
    
    private bool SetPlanet(string planet)
    {
        if (!_planets.Contains(planet)) return false;

        _selectedPlanet = planet;
        return true;
    }
    
    private void OnPlanetSelectChange(ChangeEventArgs e)
    {
        if (e.Value is string planet)
        {
            ChangePlanet(planet);
        }
    }
    
    private void ChangePlanet(string planet)
    {
        SetPlanet(planet);
        _loading = true;
        NavigationManager.NavigateTo(NavigationManager.Uri+$"#{planet}");
    }

    private async Task OnAvatarAddressChange(ChangeEventArgs arg)
    {
        _avatarAddress = arg.Value?.ToString() ?? "";
        if (!string.IsNullOrWhiteSpace(_avatarAddress))
        {
            await LocalStorage.SetItemAsStringAsync(AvatarAdressKey, _avatarAddress);
        }
        _loading = true;
    }
    
    private void OnSearchInputChange(ChangeEventArgs e)
    {
        if (e.Value is not string input) return;
        
        _currentSearch = input;

        _loading = true;
        NavigationManager.NavigateTo(NavigationManager.Uri);
    }
}